<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineVerse - Movie Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }
        .movie-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #7e22ce 100%);
        }
        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
        }
        .tabs .tab.active {
            border-bottom: 3px solid #6366f1;
            font-weight: 600;
        }
        .modal {
            transition: opacity 0.3s ease;
            background-color: rgba(0, 0, 0, 0.8);
        }
        .loader {
            border-top-color: #6366f1;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <i class="fas fa-film text-3xl mr-3"></i>
                    <h1 class="text-2xl md:text-3xl font-bold">CineVerse</h1>
                </div>
                
                <div class="relative w-full md:w-1/3">
                    <input type="text" id="search-input" placeholder="Search movies..."
                        class="w-full px-4 py-2 rounded-full text-gray-800 focus:ring-2 focus:ring-indigo-500 search-input">
                    <button id="search-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-indigo-600">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- API Key Input -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8 fade-in">
            <h2 class="text-xl font-semibold mb-4">TMDB API Key</h2>
            <div class="flex flex-col md:flex-row gap-4">
                <input type="password" id="api-key-input" placeholder="Enter your TMDB API key" 
                    class="flex-grow px-4 py-2 border rounded-lg focus:border-indigo-500">
                <button id="save-api-key" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">
                    Save Key
                </button>
            </div>
            <p class="text-gray-600 text-sm mt-2">
                Don't have an API key? <a href="https://www.themoviedb.org/signup" target="_blank" class="text-indigo-600">Get one here</a>
            </p>
        </div>

        <!-- Tabs -->
        <div class="tabs flex mb-6 border-b border-gray-200">
            <button class="tab px-4 py-2 mr-2 active" data-tab="home">Home</button>
            <button class="tab px-4 py-2 mr-2" data-tab="search">Search Results</button>
            <button class="tab px-4 py-2" data-tab="favorites">Favorites</button>
        </div>

        <!-- Home Tab Content -->
        <div id="home-tab" class="tab-content fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Categories -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-tags mr-2 text-indigo-600"></i> Categories
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        <button class="category-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-category="28">
                            Action
                        </button>
                        <button class="category-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-category="35">
                            Comedy
                        </button>
                        <button class="category-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-category="18">
                            Drama
                        </button>
                        <button class="category-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-category="14">
                            Fantasy
                        </button>
                        <button class="category-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-category="27">
                            Horror
                        </button>
                        <button class="category-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-category="10749">
                            Romance
                        </button>
                        <button class="category-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-category="53">
                            Thriller
                        </button>
                    </div>
                </div>

                <!-- Regions -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-globe mr-2 text-indigo-600"></i> Regions
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        <button class="region-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-region="IN">
                            Bollywood (Hindi)
                        </button>
                        <button class="region-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-region="US">
                            Hollywood
                        </button>
                        <button class="region-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-region="IN-KA">
                            Kannada
                        </button>
                        <button class="region-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-region="IN-ML">
                            Malayalam
                        </button>
                        <button class="region-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-region="IN-TN">
                            Tamil
                        </button>
                        <button class="region-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-region="IN-TG">
                            Telugu
                        </button>
                    </div>
                </div>

                <!-- Years -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-calendar-alt mr-2 text-indigo-600"></i> Years
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        <button class="year-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-year="2023">
                            2023
                        </button>
                        <button class="year-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-year="2022">
                            2022
                        </button>
                        <button class="year-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-year="2021">
                            2021
                        </button>
                        <button class="year-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-year="2020">
                            2020
                        </button>
                        <button class="year-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-year="2019">
                            2019
                        </button>
                        <button class="year-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-year="2010-2019">
                            2010s
                        </button>
                        <button class="year-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-year="2000-2009">
                            2000s
                        </button>
                        <button class="year-btn px-3 py-1 bg-gray-100 rounded-full hover:bg-indigo-100 transition" data-year="1990-1999">
                            1990s
                        </button>
                    </div>
                </div>

                <!-- Join Community -->
                <div class="bg-indigo-50 p-6 rounded-lg shadow-md md:col-span-2 lg:col-span-3">
                    <div class="flex flex-col md:flex-row items-center">
                        <div class="mb-4 md:mb-0 md:mr-6">
                            <i class="fas fa-users fa-3x text-indigo-600"></i>
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-xl font-semibold mb-2">Join Our Movie Community</h3>
                            <p class="text-gray-600 mb-4">Connect with fellow movie lovers, discuss films, and get recommendations!</p>
                            <a href="https://t.me/cineverse_movies" target="_blank" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition inline-flex items-center">
                                <i class="fab fa-telegram-plane mr-2"></i> Join Telegram Group
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Results Tab Content -->
        <div id="search-tab" class="tab-content hidden">
            <div id="search-results" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Results will be populated here -->
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-search fa-2x mb-2"></i>
                    <p>Search for movies to see results here</p>
                </div>
            </div>
            <div id="pagination" class="flex justify-center mt-8 hidden">
                <button id="prev-page" class="px-4 py-2 bg-gray-200 rounded-l-lg hover:bg-gray-300 disabled:opacity-50" disabled>
                    <i class="fas fa-chevron-left"></i> Prev
                </button>
                <span id="page-info" class="px-4 py-2 bg-gray-100">
                    Page 1
                </span>
                <button id="next-page" class="px-4 py-2 bg-gray-200 rounded-r-lg hover:bg-gray-300 disabled:opacity-50" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Favorites Tab Content -->
        <div id="favorites-tab" class="tab-content hidden">
            <div id="favorites-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-heart fa-2x mb-2"></i>
                    <p>Your favorite movies will appear here</p>
                    <p class="text-sm mt-2">Click the heart icon on any movie to add it to favorites</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Movie Details Modal -->
    <div id="movie-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="relative">
                <button id="close-modal" class="absolute right-4 top-4 text-white bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-75">
                    <i class="fas fa-times"></i>
                </button>
                <div id="movie-backdrop" class="h-64 md:h-96 w-full bg-gray-800 bg-cover bg-center rounded-t-lg flex items-end">
                    <div class="p-6 w-full bg-gradient-to-t from-black to-transparent">
                        <h2 id="movie-title" class="text-2xl md:text-4xl font-bold text-white"></h2>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="md:w-1/3">
                        <img id="movie-poster" src="" alt="Movie Poster" class="w-full rounded-lg shadow-md">
                    </div>
                    <div class="md:w-2/3">
                        <div class="flex items-center mb-4">
                            <span id="movie-year" class="text-gray-600 mr-3"></span>
                            <span id="movie-runtime" class="text-gray-600 mr-3"></span>
                            <span id="movie-rating" class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm flex items-center">
                                <i class="fas fa-star mr-1"></i>
                                <span id="rating-value"></span>/10
                            </span>
                            <button id="favorite-btn" class="ml-auto text-2xl text-gray-400 hover:text-red-500 transition">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                        
                        <div id="movie-genres" class="flex flex-wrap gap-2 mb-4"></div>
                        
                        <h3 class="text-lg font-semibold mb-2">Overview</h3>
                        <p id="movie-overview" class="text-gray-700 mb-6"></p>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <h4 class="text-sm font-semibold text-gray-500">Director</h4>
                                <p id="movie-director" class="text-gray-700">Unknown</p>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-gray-500">Release Date</h4>
                                <p id="movie-release-date" class="text-gray-700"></p>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-gray-500">Language</h4>
                                <p id="movie-language" class="text-gray-700"></p>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-gray-500">Budget</h4>
                                <p id="movie-budget" class="text-gray-700"></p>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h3 class="text-lg font-semibold mb-2">Watch Trailer</h3>
                            <div id="movie-trailer" class="aspect-w-16 aspect-h-9 bg-gray-200 rounded-lg flex items-center justify-center">
                                <p class="text-gray-500">No trailer available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h2 class="text-xl font-bold flex items-center">
                        <i class="fas fa-film mr-2"></i> CineVerse
                    </h2>
                    <p class="text-gray-400 mt-1">Your ultimate movie companion</p>
                </div>
                <div class="flex space-x-4">
                    <a href="#" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="https://t.me/cineverse_movies" target="_blank" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-telegram-plane"></i>
                    </a>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-gray-700 text-center text-gray-400 text-sm">
                <p>© 2023 CineVerse. All rights reserved. Powered by TMDB API.</p>
                <p class="mt-2">Data provided by <a href="https://www.themoviedb.org/" target="_blank" class="text-indigo-400 hover:underline">The Movie Database</a></p>
            </div>
        </div>
    </footer>

    <script>
        // DOM Elements
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const searchBtn = document.getElementById('search-btn');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key');
        const movieModal = document.getElementById('movie-modal');
        const closeModal = document.getElementById('close-modal');
        const loadingIndicator = document.getElementById('loading');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');
        const favoritesList = document.getElementById('favorites-list');
        
        // State variables
        let currentPage = 1;
        let totalPages = 1;
        let currentMovieId = null;
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let tmdbApiKey = localStorage.getItem('tmdbApiKey') || '';
        
        // Initialize
        if (tmdbApiKey) {
            apiKeyInput.value = tmdbApiKey;
        }
        
        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(`${tab.dataset.tab}-tab`).classList.remove('hidden');
                
                if (tab.dataset.tab === 'favorites') {
                    displayFavorites();
                }
            });
        });
        
        // Save API key
        saveApiKeyBtn.addEventListener('click', () => {
            if (apiKeyInput.value.trim()) {
                tmdbApiKey = apiKeyInput.value.trim();
                localStorage.setItem('tmdbApiKey', tmdbApiKey);
                showToast('API key saved successfully!');
            } else {
                showToast('Please enter a valid API key', 'error');
            }
        });
        
        // Search movies
        searchBtn.addEventListener('click', searchMovies);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchMovies();
            }
        });
        
        // Filter buttons
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const category = btn.dataset.category;
                tabs[1].click();
                searchByCategory(category);
            });
        });
        
        document.querySelectorAll('.region-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const region = btn.dataset.region;
                tabs[1].click();
                searchByRegion(region);
            });
        });
        
        document.querySelectorAll('.year-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const year = btn.dataset.year;
                tabs[1].click();
                searchByYear(year);
            });
        });
        
        // Pagination
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                // Re-run the last search with the new page
                const lastEvent = document.querySelector('.search-history[data-event]');
                if (lastEvent) {
                    const eventType = lastEvent.dataset.event;
                    const eventValue = lastEvent.dataset.value;
                    
                    if (eventType === 'search') {
                        searchMovies(searchInput.value, currentPage);
                    } else if (eventType === 'category') {
                        searchByCategory(eventValue, currentPage);
                    } else if (eventType === 'region') {
                        searchByRegion(eventValue, currentPage);
                    } else if (eventType === 'year') {
                        searchByYear(eventValue, currentPage);
                    }
                }
            }
        });
        
        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                // Re-run the last search with the new page
                const lastEvent = document.querySelector('.search-history[data-event]');
                if (lastEvent) {
                    const eventType = lastEvent.dataset.event;
                    const eventValue = lastEvent.dataset.value;
                    
                    if (eventType === 'search') {
                        searchMovies(searchInput.value, currentPage);
                    } else if (eventType === 'category') {
                        searchByCategory(eventValue, currentPage);
                    } else if (eventType === 'region') {
                        searchByRegion(eventValue, currentPage);
                    } else if (eventType === 'year') {
                        searchByYear(eventValue, currentPage);
                    }
                }
            }
        });
        
        // Modal
        closeModal.addEventListener('click', () => {
            movieModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        });
        
        // Wait for animations before removing the elements
        movieModal.addEventListener('animationend', (e) => {
            if (e.animationName === 'fadeOut') {
                movieModal.classList.add('hidden');
            }
        });
        
        // Helper functions
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } z-50 animate-bounce`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('animate-bounce');
                toast.classList.add('animate-fadeOut');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }
        
        async function fetchFromTMDB(url) {
            if (!tmdbApiKey) {
                showToast('Please enter your TMDB API key first', 'error');
                return null;
            }
            
            try {
                loadingIndicator.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching from TMDB:', error);
                showToast('Failed to fetch data. Please check your API key.', 'error');
                return null;
            } finally {
                loadingIndicator.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        }
        
        function formattedDate(dateString) {
            if (!dateString) return 'Unknown';
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        function formatCurrency(amount) {
            if (!amount) return 'Unknown';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        function formatRuntime(minutes) {
            if (!minutes) return 'Unknown';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }
        
        // Movie search functions
        async function searchMovies(query, page = 1) {
            if (!query || !query.trim()) {
                showToast('Please enter a search query', 'error');
                return;
            }
            
            const url = `https://api.themoviedb.org/3/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(query)}&page=${page}&include_adult=false`;
            const data = await fetchFromTMDB(url);
            
            if (data) {
                displayResults(data.results);
                
                // Update pagination
                currentPage = data.page;
                totalPages = data.total_pages;
                updatePagination();
                
                // Save this search event
                searchResults.innerHTML = '';
                searchResults.setAttribute('data-event', 'search');
                searchResults.setAttribute('data-value', query);
            }
        }
        
        async function searchByCategory(genreId, page = 1) {
            const url = `https://api.themoviedb.org/3/discover/movie?api_key=${tmdbApiKey}&with_genres=${genreId}&page=${page}&sort_by=popularity.desc`;
            const data = await fetchFromTMDB(url);
            
            if (data) {
                displayResults(data.results);
                
                // Update pagination
                currentPage = data.page;
                totalPages = data.total_pages;
                updatePagination();
                
                // Save this search event
                searchResults.innerHTML = '';
                searchResults.setAttribute('data-event', 'category');
                searchResults.setAttribute('data-value', genreId);
            }
        }
        
        async function searchByRegion(region = 'US', page = 1) {
            // Handle Indian regional cinema
            let languageParam = '';
            let regionParam = region;
            
            if (region.startsWith('IN-')) {
                // Indian regional cinema
                const stateCode = region.split('-')[1];
                
                // Map state codes to languages
                const languageMap = {
                    'KA': 'kn', // Kannada
                    'MH': 'mr', // Marathi
                    'ML': 'ml', // Malayalam
                    'TN': 'ta', // Tamil
                    'TG': 'te'  // Telugu
                };
                
                languageParam = `&with_original_language=${languageMap[stateCode] || 'hi'}`;
                regionParam = 'IN'; // Still search within India
            }
            
            const url = `https://api.themoviedb.org/3/discover/movie?api_key=${tmdbApiKey}&region=${regionParam}${languageParam}&page=${page}&sort_by=popularity.desc`;
            const data = await fetchFromTMDB(url);
            
            if (data) {
                displayResults(data.results);
                
                // Update pagination
                currentPage = data.page;
                totalPages = data.total_pages;
                updatePagination();
                
                // Save this search event
                searchResults.innerHTML = '';
                searchResults.setAttribute('data-event', 'region');
                searchResults.setAttribute('data-value', region);
            }
        }
        
        async function searchByYear(year, page = 1) {
            let startDate = '';
            let endDate = '';
            
            if (year.includes('-')) {
                // Year range like 2010-2019
                const [startYear, endYear] = year.split('-').map(y => parseInt(y));
                startDate = `${startYear}-01-01`;
                endDate = `${endYear}-12-31`;
            } else {
                // Single year
                startDate = `${year}-01-01`;
                endDate = `${year}-12-31`;
            }
            
            const url = `https://api.themoviedb.org/3/discover/movie?api_key=${tmdbApiKey}&primary_release_date.gte=${startDate}&primary_release_date.lte=${endDate}&page=${page}&sort_by=popularity.desc`;
            const data = await fetchFromTMDB(url);
            
            if (data) {
                displayResults(data.results);
                
                // Update pagination
                currentPage = data.page;
                totalPages = data.total_pages;
                updatePagination();
                
                // Save this search event
                searchResults.innerHTML = '';
                searchResults.setAttribute('data-event', 'year');
                searchResults.setAttribute('data-value', year);
            }
        }
        
        function updatePagination() {
            if (totalPages > 1) {
                document.getElementById('pagination').classList.remove('hidden');
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
            } else {
                document.getElementById('pagination').classList.add('hidden');
            }
        }
        
        // Display functions
        function displayResults(movies) {
            searchResults.innerHTML = '';
            
            if (!movies || movies.length === 0) {
                searchResults.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-film fa-2x mb-2"></i>
                        <p>No movies found. Try a different search.</p>
                    </div>
                `;
                return;
            }
            
            movies.forEach(movie => {
                const posterPath = movie.poster_path 
                    ? `https://image.tmdb.org/t/p/w500${movie.poster_path}`
                    : 'https://via.placeholder.com/500x750?text=No+Poster';
                
                const isFavorite = favorites.includes(movie.id.toString());
                
                const card = document.createElement('div');
                card.className = 'movie-card bg-white rounded-lg overflow-hidden shadow-md hover:shadow-xl transition';
                card.innerHTML = `
                    <div class="relative">
                        <img src="${posterPath}" alt="${movie.title}" class="w-full h-64 object-cover" loading="lazy">
                        <button class="absolute top-2 right-2 text-2xl ${isFavorite ? 'text-red-500' : 'text-white'} hover:text-red-500 transition" data-movie-id="${movie.id}" onclick="toggleFavorite(this)">
                            <i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i>
                        </button>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-3">
                            <span class="text-white text-sm bg-yellow-500 px-2 py-1 rounded inline-flex items-center">
                                <i class="fas fa-star mr-1 text-xs"></i> ${movie.vote_average.toFixed(1)}
                            </span>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-lg mb-1 truncate">${movie.title}</h3>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>${movie.release_date ? movie.release_date.substring(0, 4) : 'Unknown'}</span>
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => showMovieDetails(movie.id));
                searchResults.appendChild(card);
            });
        }
        
        async function showMovieDetails(movieId) {
            currentMovieId = movieId;
            
            // Basic movie details
            const movieUrl = `https://api.themoviedb.org/3/movie/${movieId}?api_key=${tmdbApiKey}`;
            const movieData = await fetchFromTMDB(movieUrl);
            if (!movieData) return;
            
            // Get credits to find director
            const creditsUrl = `https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${tmdbApiKey}`;
            const creditsData = await fetchFromTMDB(creditsUrl);
            
            // Get videos (trailers)
            const videosUrl = `https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${tmdbApiKey}`;
            const videosData = await fetchFromTMDB(videosUrl);
            
            // Update modal with movie data
            const backdropPath = movieData.backdrop_path 
                ? `https://image.tmdb.org/t/p/w1280${movieData.backdrop_path}`
                : 'https://via.placeholder.com/1280x720?text=No+Backdrop';
            
            // Set backdrop image
            document.getElementById('movie-backdrop').style.backgroundImage = `url(${backdropPath})`;
            
            // Set poster image
            const posterPath = movieData.poster_path 
                ? `https://image.tmdb.org/t/p/w500${movieData.poster_path}`
                : 'https://via.placeholder.com/500x750?text=No+Poster';
            document.getElementById('movie-poster').src = posterPath;
            
            // Set basic info
            document.getElementById('movie-title').textContent = movieData.title;
            document.getElementById('movie-year').textContent = movieData.release_date ? movieData.release_date.substring(0, 4) : 'Unknown';
            document.getElementById('movie-runtime').textContent = formatRuntime(movieData.runtime);
            document.getElementById('rating-value').textContent = movieData.vote_average.toFixed(1);
            document.getElementById('movie-overview').textContent = movieData.overview || 'No overview available.';
            document.getElementById('movie-release-date').textContent = formattedDate(movieData.release_date);
            document.getElementById('movie-language').textContent = movieData.spoken_languages.length > 0 
                ? movieData.spoken_languages[0].english_name 
                : 'Unknown';
            document.getElementById('movie-budget').textContent = formatCurrency(movieData.budget);
            
            // Set genres
            const genresContainer = document.getElementById('movie-genres');
            genresContainer.innerHTML = '';
            movieData.genres.forEach(genre => {
                const genreBadge = document.createElement('span');
                genreBadge.className = 'bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded';
                genreBadge.textContent = genre.name;
                genresContainer.appendChild(genreBadge);
            });
            
            // Set director (from credits)
            if (creditsData) {
                const directors = creditsData.crew.filter(person => person.job === 'Director');
                document.getElementById('movie-director').textContent = directors.length > 0 
                    ? directors.map(d => d.name).join(', ')
                    : 'Unknown';
            }
            
            // Set trailer (from videos)
            const trailerContainer = document.getElementById('movie-trailer');
            trailerContainer.innerHTML = '';
            
            if (videosData && videosData.results.length > 0) {
                const trailers = videosData.results.filter(video => 
                    video.site === 'YouTube' && video.type === 'Trailer'
                );
                
                if (trailers.length > 0) {
                    // Get the official trailer first, or fall back to any trailer
                    const officialTrailer = trailers.find(t => t.official) || trailers[0];
                    trailerContainer.innerHTML = `
                        <iframe class="w-full h-full rounded-lg" 
                                src="https://www.youtube.com/embed/${officialTrailer.key}" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen></iframe>
                    `;
                } else {
                    trailerContainer.innerHTML = '<p class="text-gray-500">No trailer available</p>';
                }
            } else {
                trailerContainer.innerHTML = '<p class="text-gray-500">No trailer available</p>';
            }
            
            // Update favorite button
            const isFavorite = favorites.includes(movieId.toString());
            const favoriteBtn = document.getElementById('favorite-btn');
            favoriteBtn.innerHTML = `<i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i>`;
            favoriteBtn.onclick = () => toggleFavorite(favoriteBtn);
            
            // Show modal
            movieModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // Favorite functionality
        function toggleFavorite(button) {
            const movieId = button.getAttribute('data-movie-id');
            
            if (!movieId) return;
            
            const index = favorites.indexOf(movieId);
            const isFavorite = index !== -1;
            
            if (isFavorite) {
                favorites.splice(index, 1);
                if (button.classList.contains('text-red-500')) {
                    button.classList.remove('text-red-500');
                }
                button.innerHTML = '<i class="far fa-heart"></i>';
                showToast('Removed from favorites');
            } else {
                favorites.push(movieId);
                if (!button.classList.contains('text-red-500')) {
                    button.classList.add('text-red-500');
                }
                button.innerHTML = '<i class="fas fa-heart"></i>';
                showToast('Added to favorites');
            }
            
            // Update localStorage
            localStorage.setItem('favorites', JSON.stringify(favorites));
            
            // If we're on the favorites tab, refresh the display
            if (document.querySelector('.tab.active').dataset.tab === 'favorites') {
                displayFavorites();
            }
        }
        
        function displayFavorites() {
            favoritesList.innerHTML = '';
            
            if (favorites.length === 0) {
                favoritesList.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-heart fa-2x mb-2"></i>
                        <p>Your favorite movies will appear here</p>
                        <p class="text-sm mt-2">Click the heart icon on any movie to add it to favorites</p>
                    </div>
                `;
                return;
            }
            
            // Show placeholder cards while loading
            favoritesList.innerHTML = `
                <div class="col-span-full text-center py-12 text-gray-500">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
                    <p>Loading your favorites...</p>
                </div>
            `;
            
            // Load each favorite movie's details
            const promises = favorites.map(movieId => 
                fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${tmdbApiKey}`).then(res => res.json())
            );
            
            Promise.all(promises)
                .then(movies => {
                    favoritesList.innerHTML = '';
                    
                    movies.forEach(movie => {
                        if (movie.success === false) return; // Skip invalid movies
                        
                        const posterPath = movie.poster_path 
                            ? `https://image.tmdb.org/t/p/w500${movie.poster_path}`
                            : 'https://via.placeholder.com/500x750?text=No+Poster';
                        
                        const card = document.createElement('div');
                        card.className = 'movie-card bg-white rounded-lg overflow-hidden shadow-md hover:shadow-xl transition';
                        card.innerHTML = `
                            <div class="relative">
                                <img src="${posterPath}" alt="${movie.title}" class="w-full h-64 object-cover" loading="lazy">
                                <button class="absolute top-2 right-2 text-2xl text-red-500 hover:text-red-700 transition" data-movie-id="${movie.id}" onclick="toggleFavorite(this)">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-3">
                                    <span class="text-white text-sm bg-yellow-500 px-2 py-1 rounded inline-flex items-center">
                                        <i class="fas fa-star mr-1 text-xs"></i> ${movie.vote_average.toFixed(1)}
                                    </span>
                                </div>
                            </div>
                            <div class="p-4">
                                <h3 class="font-semibold text-lg mb-1 truncate">${movie.title}</h3>
                                <div class="flex justify-between text-sm text-gray-600">
                                    <span>${movie.release_date ? movie.release_date.substring(0, 4) : 'Unknown'}</span>
                                </div>
                            </div>
                        `;
                        
                        card.addEventListener('click', () => showMovieDetails(movie.id));
                        favoritesList.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error loading favorites:', error);
                    favoritesList.innerHTML = `
                        <div class="col-span-full text-center py-12 text-gray-500">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>Failed to load favorites. Please check your API key.</p>
                        </div>
                    `;
                });
        }
        
        // Expose functions to global scope for button onclick handlers
        window.toggleFavorite = toggleFavorite;
        window.showMovieDetails = showMovieDetails;
    </script>
</body>
</html>
